name: Deploy to Minikube

on:
  workflow_dispatch:
    inputs:
      service:
        description: "Select the service to deploy"
        required: true
        type: choice
        options:
          - authentication
          - api-gateway
      version:
        description: "Version (leave empty to use the latest)"
        required: false

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout deploy repository
        uses: actions/checkout@v4

      - name: Install tools (yq + jq + curl)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq curl
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Determine service version
        id: get_version
        run: |
          SERVICE="${{ github.event.inputs.service }}"
          INPUT_VERSION="${{ github.event.inputs.version }}"

          if [ -n "$INPUT_VERSION" ]; then
            VERSION="$INPUT_VERSION"
          else
            echo "Version not specified — fetching latest for $SERVICE..."
            VERSION=$(curl -s "https://registry.hub.docker.com/v2/repositories/one290/shadowchats/tags?page_size=100" \
              | jq -r --arg SERVICE "$SERVICE" '.results[].name | select(startswith($SERVICE + "-v"))' \
              | sort -V | tail -n 1)
          fi

          if [ -z "$VERSION" ]; then
            echo "❌ Version for service $SERVICE not found!"
            exit 1
          fi

          echo "service=$SERVICE" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Update deployment.yaml
        run: |
          SERVICE="${{ steps.get_version.outputs.service }}"
          VERSION="${{ steps.get_version.outputs.version }}"

          echo "Updating $SERVICE/deployment.yaml -> one290/shadowchats:${VERSION}"
          yq e -i ".spec.template.spec.containers[0].image = \"one290/shadowchats:${VERSION}\"" $SERVICE/deployment.yaml

      - name: Apply service manifests
        run: |
          SERVICE="${{ steps.get_version.outputs.service }}"
          echo "Applying manifests from $SERVICE/"
          kubectl apply -f $SERVICE/
          kubectl rollout status -f $SERVICE/deployment.yaml
